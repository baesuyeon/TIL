> 참고: 가상 면접 사례로 배우는 대규모 시스템 설계 기초 > 키-값 저장소 설계

## 키-값 저장소
키-값 저장소로 널리 알려진것으로는 아마존 다이나모, memcached, 레디스 등이 있다.
이 저장소에 저장되는 값은 고유 식별자를 키로 가져야 한다.
키-값 쌍에서 키는 유일해야 하며 키는 일반 텍스트일 수도 있고 해시 값일 수도 있다.

다음 연산을 지원하는 키-값 저장소를 설계해보자
* put(key, value): 키-값 쌍을 저장소에 저장한다.
* get(key): 인자로 주어진 키에 매달린 값을 꺼낸다.

## 단일 서버 키-값 저장소
단일 서버에서 동작하는 기본적인 키-값 저장소는 모든 키-값 쌍을 메모리 내 해시 테이블에 보관할 수 있다.
하지만 모든 데이터를 메모리에 담는 것은 한계가 있기 때문에 다음과 같은 개선 방법이 활용된다.

* 데이터 압축: 저장 공간을 줄여 더 많은 데이터를 메모리에 적재할 수 있다.
* 메모리 + 디스크 혼합 사용: 자주 사용되는 데이터는 메모리에 유지하고, 사용 빈도가 낮은 데이터는 디스크에 저장한다.

## 분산 키-값 저장소
* 분산 시스템이 필요한 이유
1. 확장성(Scalability)
단일 서버의 CPU, 메모리, 디스크 성능에는 한계가 있다.
사용자 수나 데이터 양이 폭발적으로 늘어나면 서버를 여러 대로 나눠서 처리해야 한다.
(수억 명 요청을 단일 서버로는 감당 불가)
(단일 서버의 디스크 용량은 제한적이기 떄문에 데이터가 테라바이트(TB), 페타바이트(PB) 단위로 커지면 반드시 여러 대 서버에 분산 저장해야 한다)


2. 가용성(Availability) & 장애 대응(Fault Tolerance)
서버 한 대는 언제든 장애가 날 수 있다. (디스크 고장, 네트워크 장애, 메모리 부족 등)
분산 시스템은 여러 노드에 데이터와 요청을 분산해두므로, 일부 서버가 죽어도 서비스가 멈추지 않는다.
(카카오톡 메시지 서버 일부가 다운되어도 대화가 멈추지 않는 이유)

3. 성능(Performance) & 지연 시간(Latency) 최적화
전 세계 사용자에게 서비스를 제공할 때, 한국에서만 서버를 두면 미국/유럽 유저는 응답 속도가 느려진다.
분산 시스템을 통해 여러 지역(Region)에 서버를 배치하면 사용자 가까운 서버가 응답해 지연을 줄일 수 있다.
(CDN(Content Delivery Network) — 이미지, 동영상 서버를 세계 각지에 분산 배치)

4. 저비용(Commodity Hardware 활용)
예전에는 성능 좋은 슈퍼컴퓨터를 써야 했지만 지금은 저렴한 범용 서버를 여러 대 묶어 고성능을 내는 게 일반적이다.

키-값 쌍을 여러 서버에 분산시킬 수 있다. 
분산 시스템을 설계할 때는 `CAP 정리`를 이해하고 있어야 한다.

### CAP 정리
CAP 정리는 데이터 일관성(consistency), 가용성(availability), 파티션 감내(partition tolerance)라는
세 가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 이론이다.

* 데이터 일관성: 모든 클라이언트는 어느 노드에 접속하더라도 항상 동일한 데이터를 조회할 수 있어야 한다.
* 가용성: 일부 노드에 장애가 발생하더라도 클라이언트의 요청에 항상 응답할 수 있어야 한다.
* 파티션 감내: 분산 시스템은 여러 대의 서버(노드)가 네트워크로 연결되어 하나의 시스템처럼 동작한다. 
  그런데 네트워크는 완벽하지 않아서 끊기거나, 지연되거나, 특정 노드 간 통신이 불가능한 상황이 발생할 수 있다.
  이런 상황(클러스터가 서로 다른 파티션(분리된 그룹)으로 나뉘더라도)에서도 시스템이 계속 동작할 수 있어야 한다.

네트워크가 끊어졌다면 파티션 감내는 사실상 피할 수 없는 현실이므로 분산 시스템은 반드시 파티션 문제를 감내할 수 있도록 설계되어야 한다.
따라서 분산 시스템은 일관성(Consistency) vs 가용성(Availability) 중 하나를 희생해야 한다.
- CP 시스템: 파티션이 생기면, 일부 요청은 막아서라도 데이터 일관성을 유지 (ex. HBase, Zookeeper)
  - 모두가 똑같은 데이터를 보는 게 중요.
- AP 시스템: 파티션이 생겨도 응답은 주지만, 잠시 일관성이 깨질 수 있음 (ex. Cassandra, DynamoDB)
  - 요청이 오면 무조건 응답을 준다는 개념.

## 실세계의 분산 시스템
<img width="313" height="239" alt="Image" src="https://github.com/user-attachments/assets/15e23424-953c-45f7-8460-0130ec40398d" />

위와 같이 n3에 장애가 발생하여 n1, n2와 통신할 수 없는 네트워크 파티션 문제가 발생하면
n1, n2에 기록된 데이터는 n3에 전달되지 않고 n3에 기록되었으나 아직 n1, n2에 전달되지 않은 데이터가 있을 수 있다.

* 일관성을 선택한다면
  * 세 서버 사이에 생길 수 있는 데이터 불일치 문제를 피하기 위해 n1, n2에 대해 쓰기 연산을 중단시킬 수 있다.
  * 은행 시스템은 보통 데이터 일관성을 양보하지 않는다.
  * 네트워크 파티션때문에 일관성이 깨질 수 있는 상황이 발생하면 상황이 해결될때까지 오류를 반환해야 한다.

* 가용성을 선택한다면
  * 낡은 데이터를 반환한다고 하더라도 읽기 연산을 허용하고, n1, n2는 계속 쓰기 연산을 허용한다.
  * 파티션 문제가 해결되었을 때 세 데이터를 n3에 전송한다.

## 시스템 컨포넌트
### 데이터 파티션
대규모 애플리케이션에서는 전체 데이터를 단일 서버에 모두 저장하는 것이 불가능하다.
따라서 데이터를 여러 개의 작은 파티션으로 나눈 뒤, 여러 서버에 분산 저장하는 방식이 필요하다.

이때 고려해야 할 핵심 사항은 다음과 같다
* 균등한 분산: 데이터를 여러 서버에 가능한 한 고르게 나누어 저장하여 특정 서버에 부하가 집중되지 않도록 해야 한다.
* 데이터 이동 최소화: 서버(노드)가 추가되거나 삭제될 때, 전체 데이터가 대규모로 재배치되지 않고 필요한 데이터만 최소한으로 이동할 수 있어야 한다.