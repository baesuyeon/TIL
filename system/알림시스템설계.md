> 참고: 가상 면접 사례로 배우는 대규모 시스템 설계 기초 > 알림 시스템 설계

알림 시스템은 단순히 모바일 푸시 알림에 한정하지 않고
모바일 푸시 알림, SMS 메시지, 이메일 세 가지로 분류할 수 있다.


## 알림 유형별 지원 방안

**iOS 푸시 알림** 
```text
[알림 제공자] -> [APNS] -> [iOS 단말]
```
iOS에서 푸시 알림을 보내기 위해서는 3가지 컴포넌트가 필요하다.

알림 제공자 : 알림 요청을 만들어 APNS(애플 푸시 알림 서비스)로 보내는 주체다.
알림 요청을 만드려면 다음과 같은 데이터가 필요하다.
* 단말 토큰(device token) : 알림 요청을 보내는데 필요한 고유 식별자이다.
* 페이로드(payload) : 알림 내용을 담은 JSON 딕셔너리다.
```text
{
  "aps": {
    "alert": {
      "title": "Game Requeest",
      "body": "Bob wants to play chess",
      "action-loc-key": "PLAY"
    },
    "bade": 5
  }
}
```

APNS : 애플이 제공하는 원격 서비스다. 푸시 알림을 iOS 장치로 보내는 역할을 담당한다.

**안드로이드 알림**
```text
[알림 제공자] -> [FCM] -> [안드로이드 단말]
```
APNS 대신 FCM을 사용한다는 점만 다르다

**SMS 메시지**
```text
[알림 제공자] -> [SMS 서비스] -> [단말]
```
SMS 메시지를 보낼 때는 보통 트윌리오(Twilio), 넥스모(Nexmo)와 같은 제3사업자의 서비스를 많이 이용한다.
대부분 상용 서비스라서 이용요금을 내야한다.

**이메일**
```text
[알림 제공자] -> [이메일 서비스] -> [단말]
```
상용 이메일 서비스 중 유명한 서비스로 센드그리드(Sendgrid), 메일침프(Mailchimp)가 있다.

## 연락처 정보 수집 절차
알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.
사용자가 우리 앱을 설치하거나 처음으로 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장한다.

user 테이블
* user_id
* email
* country_code
* phone_number
* created_at

device 테이블
* id
* device_token
* user_id
* last_logged_in_ar

단말 토큰은 device 테이블에 저장한다.
한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말에 전송되어야 한다는 점을 고려햐였다.

## 설계
시스템 컴포넌트 간 의존성을 제거하기 위해 메시지 큐를 사용할 수 있다.
다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할도 한다.
알림의 종류별로 별도 메시지 큐를 사용해 제 3자 서비스 중 하나에 장애가 발생해도 다른 종류의 알림은 정상동작하게된다.

작업 서버는 메시지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달하는 역할을 담당한다.

1. API를 호출하여 알림 서버로 알림을 보낸다.
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 데이터베이스에서 가져온다.
3. 알림 서버는 전송할 알림에 맞는 이벤트를 만들어서 해당 이벤트를 위한 큐에 넣는다.
   4. iOS 푸시 알림 이벤트는 iOS 푸시 알림 큐에 넣어야 한다.
5. 작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다.
6. 작업 서버는 알림을 제 3서비스로 보낸다.
7. 제 3서비스는 사용자 단말로 알림을 전송한다.

### 안정성 > 데이터 손실 방지
알림 전송 시스템의 가장 중요한 요구사항 가운데 하나는 어떤 상황에서도 알림이 소실되면 안된다는 것이다.
이 요구사항을 만족하려면 알림 시스템은 알림 데이터를 DB에 보관하고 재시도 메커니즘을 구현해야 한다.
작업 서버에 알림 로그(notification log) 데이터베이스를 붙이는 것이 한가지 방법이다.

### 알림 중복 전송 방지
보내야할 알림이 도착하면 그 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 살핀다.
중복된 이벤트라면 버리고 그렇지 않으면 알림을 발송한다.

### 알림 템플릿
알림 메시지 대부분은 형식이 비슷하다.
알림 템플릿은 이런 유사성을 고려하여 알림 메시지의 모든 부분을 처음부터 다시 만들 필요 없게 해준다.
ex) 
본문: 여러분이 꿈꿔온 그 상품을 우리가 준비했습니다. [item_name]이 다시 입고되었습니다. [date]까지만 주문 가능합니다!
타이틀 : 지금 [item_name]을 주문 또는 예약하세요!

### 알림 설정
사용자는 알림 설정을 조정할 수 있어야 한다.

* user_id
* channel : 알림이 전송될 채널, 푸시 알림, 이메일, SMS 등
* opt_in (boolean) : 해당 채널로 알림을 받을 것인지의 여부

### 재시도 방법
제3자 서비스가 알림 전송에 실패하면 해당 알림을 재시도 전용 큐에 넣고 지정된 횟수만큼 재시도 한다.
같은 문제가 계속해서 발생하면 개발자에게 통지한다.