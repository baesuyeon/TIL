## 쿠키와 세션 ✅

쿠키와 세션을 왜 사용할까?
HTTP 프로토콜의 특징이자 약점을 보완하기 위해서 사용한다.

### HTTP 프로토콜의 약점

1) 비연결지향 <br>
   HTTP는 먼저 클라이언트가 request를 서버에 보내면,
   서버는 클라이언트에게 요청에 맞는 response를 보내고 **접속을 끊는 특성**이 있다.

2) 상태정보 유지안함 <br>
   연결을 끊는 순간 클라이언트와 서버의 통신이 끝나며 **상태 정보는 유지하지 않는** 특성이 있다.

HTTP의 이 두가지 특성을 보완하기 위해서 쿠키와 세션을 사용하게 되었다.
비연결지향이라는 특성 덕분에 계속해서 통신 연결을 유지하지 않기 때문에 리소스 낭비가 줄어드는 것은 아주 큰 장점이지만
통신할 때마다 새로 커넥션을 열기 때문에 클라이언트는 내가 누구인지 인증을 계속해야하는 단점이 생긴다.

만약 쿠키와 세션이 없다면 어떤 페이지에서 옮겨다닐 때마다 로그인을 다시해야 한다.

## 쿠키

```text
Cookie = {
  name: "SESSIONID",
  value: "abc123",
  attributes: {
    Path: "/",
    Max-Age: 3600,
    Domain: "example.com",
    Secure: true,
    HttpOnly: true,
    SameSite: Lax
  }
}
```

`Path`, `Max-Age` 등은 브라우저가 관리하는 속성
서버로 전송되는 건 `name=value`이다.

쿠키는 클라이언트 로컬(쿠키 저장소)에 저장되는 키와 값이 들어있는 작은 데이터 파일이다.
쿠키에는 이름, 값, 만료날짜(쿠키 저장기간), 경로 정보가 들어있다.

## 쿠키 저장 방식에 따른 분류

`setPath()` 메소드를 사용하여 쿠키 경로 지정시 웹 브라우저는 지정한 경로 혹은 하위 경로에 대해서만 쿠키를 전송한다. <br>
`/api` → `/api/test` 요청 시 쿠키 포함
`/`로 설정하면 애플리케이션 전역에서 사용 가능

| 구분    | 세션 쿠키                 | 영속 쿠키                   |
|-------|-----------------------|-------------------------|
| 만료 설정 | 설정 안함                 | setMaxAge() 등으로 설정      |
| 저장 위치 | 브라우저 메모리 (RAM)        | 클라이언트 하드디스크 (HDD/SSD)   |
| 유지 기간 | 브라우저 종료 시 즉시 삭제       | 브라우저를 꺼도 설정 시간 동안 유지    |
| 용도    | 임시 데이터, 보안이 필요한 세션 ID | 로그인 상태 유지, 7일간 보지 않기 등) |

쿠키는 일정시간동안 데이터를 저장할 수 있다. (로그인 상태 유지에 활용)
`setMaxAge()` 메소드를 이용하여** 초 단위로 유효시간을 지정할 수 있다.
쿠키의 유효시간을 지정하지 않으면 웹 브라우저를 종료할 때 쿠키를 함께 삭제한다.

쿠키에 만료일이 포함되어 있지 않은 경우 메모리에 저장되고 하드 디스크에 저장되지 않는다.
쿠키에 만료일이 포함되어 있는 경우 브라우저를 종료해도 하드디스크에 저장되며 만료 시기가 되면 삭제된다.

## 쿠키 프로세스

```text
[사용자(브라우저)]                                   [서버]
      👤                                               ☁️
      |                                                |
1.    | ---------------- Request --------------------> |
      |                 (쿠키 없음)                      |
      |                                                |
2.    | <----------- Response (Set-Cookie) ----------- |
      |                  🍪 쿠키                        |
      |                                                |
3.    | ------------- Request (Cookie 포함) --------->  |
      |              🍪 Cookie: key=value              |
      |                                                |
4.    | <---------------- Response ------------------- |
      |              (쿠키 기반 처리 완료)                  |
```

서버가 **응답 헤더**에 `Set-Cookie` 속성을 통해 웹 브라우저에 전달하면
클라이언트는 쿠키를 로컬(쿠키 저장소)에 저장한다.
이후 요청 시마다 브라우저에서 쿠키값을 자동으로 추가해준다.

* 쿠키 사용 사례: 로그인 시 아이디 자동완성, 팝업에서 "오늘 더 이상 이 창을 보지 않음" 체크, 비로그인 쇼핑몰 장바구니
* 쿠키의 제한: 클라이언트에 300개까지 쿠키 저장 가능, 하나의 도메인당 20개의 값만 가질 수 있음, 하나의 쿠키값은 4KB까지 저장

## 세션
세션은 일정 시간동안 같은 브라우저로 부터 들어오는 일련의 요구를 하나의 상태로 보고 그 상태를 유지하는 기술이다.
즉 웹 브라우저를 통해 웹 서버에 접속한 이후로 브라우저를 종료할 때 까지 유지되는 상태입니다.

세션은 서버 메모리 공간에 저장된다. (로그인 정보 유지 등에 활용)
즉 서버에서 처리하기 때문에 비교적 보안성이 좋다.

웹 브라우저마다 별도의 세션을 갖게되는데 서버는 각 세션을 구분하기 위해 세션마다 고유한 세션 ID를 부여하고 클라이언트 쿠키로 저장한다.
서버는 클라이언트에 세션 ID를 전송하고 클라이언트는 서버에 연결할 때마다 매번 세션 ID를 보내서 웹 서버가 어떤 세션을 사용할지 판단할 수 있게 한다.
서로 다른 클라이언트(각 브라우저)는 서로 다른 세션 ID를 이용하여 서로 다른 세션 객체에 접근한다.

세션 ID를 공유하기 위해 JSESSION 쿠키를 사용한다.
즉 세션 ID를 쿠키로 관리한다.

* 각 사용자를 어떻게 구별할까? 세션 ID(톰캣이 부여)
* 세션 ID는 어디에 저장할까? 쿠키(클라이언트)
* 어떻게? 서버에서 응답 줄 때 **응답 헤더의** `set-Cookie`에 세션 ID 셋팅
* 세션의 수명은? 세션은 마지막 요청 이후 일정 시간 동안 요청이 없으면 만료

## 세션의 구조
세션은 Map이다. 이때 사용자를 구분하기 위한 JSESSIONID가 존재한다.
`Map<JSESSIONID, Map<AttributeKey, Value>>`

세션은 언제 생성될까? `request.getSession()` 호출 시

세션은 사용자를 어떻게 구분할까? 세션 ID를 통해 식별한다.
세션 ID는 개발자가 클라이언트에 전달해야 할까? WAS(톰캣)이 자동으로 부여한다.(response.addCookie(cookieForSessionID))
WAS가 SecureRandom 기반으로 세션 ID를 생성한다
세션을 주로 사용하면 좋은데 왜 쿠키를 사용할까? 세션은 서버의 자원을 사용하기때문에 무분별하게 만들다보면 서버의 메모리가 감당할 수 없어질 수가 있고 속도가 느려질 수 있기 때문이다.